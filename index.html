<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF--8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿ç“¦éš†åœ¨çº¿</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background-color: #f0f2f5; }
        .container { width: 90%; max-width: 800px; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        h1, h2 { text-align: center; color: #333; }
        .input-group { margin-bottom: 15px; }
        input[type="text"], button { width: 100%; padding: 12px; font-size: 16px; border-radius: 4px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #game-board { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        #players-info, #game-info { padding: 15px; border: 1px solid #eee; border-radius: 5px; }
        #game-info {
            display: flex;
            flex-direction: column;
        }
        #game-status {
            margin-top: 5px; /* ä¸ä¸Šæ–¹çš„é¢æ¿éš”å¼€ä¸€ç‚¹è·ç¦» */
            margin-bottom: 15px; /* ä¸ä¸‹æ–¹çš„è¡ŒåŠ¨åŒºéš”å¼€è·ç¦» */
            text-align: center;
            font-weight: bold;
            color: #495057;
        }
        .info-block {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .info-block p {
            margin: 8px 0;
        }

        #game-info h4 {
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        #players-list label { display: block; padding: 5px; }
        .player-item.leader { font-weight: bold; color: #d9534f; }
        .player-item.on-team { background-color: #dff0d8; }
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.7); color: white; padding: 15px 25px; border-radius: 5px; z-index: 1000; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; text-align: center; }
        #mission-markers { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .mission-marker { width: 40px; height: 40px; border: 2px solid #ccc; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        .mission-marker.success { background-color: #5cb85c; color: white; border-color: #4cae4c; }
        .mission-marker.fail { background-color: #d9534f; color: white; border-color: #d43f3a; }
        .vote-track-marker { width: 20px; height: 20px; border: 1px solid #333; border-radius: 50%; }
        .vote-track-marker.active { background-color: #d9534f; }
    </style>
</head>
<body>
    <div class="container">
        <div id="login-view">
            <h1>é˜¿ç“¦éš†</h1>
            <div class="input-group">
                <input type="text" id="player-name" placeholder="è¾“å…¥ä½ çš„æ˜µç§°">
            </div>
            <div class="input-group">
                <input type="text" id="room-id-input" placeholder="è¾“å…¥æˆ¿é—´å· (ç•™ç©ºåˆ™åˆ›å»º)">
            </div>
            <button id="join-btn">åŠ å…¥/åˆ›å»ºæˆ¿é—´</button>
        </div>

        <div id="lobby-view" class="hidden">
            <h2>æˆ¿é—´å·: <span id="room-id-display"></span></h2>
            <h3>ç©å®¶åˆ—è¡¨ (<span id="player-count"></span>):</h3>
            <ul id="lobby-players-list"></ul>
            <button id="start-game-btn">å¼€å§‹æ¸¸æˆ (5-10äºº)</button>
        </div>

        <div id="game-view" class="hidden">
            <div id="game-board">
                <div id="players-info">
                    <h3>ç©å®¶åˆ—è¡¨</h3>
                    <div id="players-list"></div>
                </div>
                <div id="game-info">
                    <div class="info-block">
                        <h4>æˆ‘çš„æƒ…æŠ¥</h4>
                        <p><strong>èº«ä»½:</strong> <span id="my-role"></span></p>
                        <p id="teammates-info" style="min-height: 2.5em;"></p> </div>

                    <div class="info-block">
                        <h4>æ¸¸æˆé¢æ¿</h4>
                        <strong>ä»»åŠ¡è¿›åº¦:</strong>
                        <div id="mission-markers"></div>
                        <strong>æŠ•ç¥¨è½¨é“ (<span id="vote-track-count">0</span>/5):</strong>
                        <div id="vote-track" style="display: flex; gap: 5px; margin-top: 5px;"></div>
                    </div>

                    <div id="game-status"></div>
                    <div id="action-area"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification" class="hidden notification"></div>
    <div id="modal" class="hidden modal-overlay">
        <div class="modal-content" id="modal-content"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // è§†å›¾å…ƒç´ 
        const loginView = document.getElementById('login-view');
        const lobbyView = document.getElementById('lobby-view');
        const gameView = document.getElementById('game-view');

        // è¾“å…¥å’ŒæŒ‰é’®
        const playerNameInput = document.getElementById('player-name');
        const roomIdInput = document.getElementById('room-id-input');
        const joinBtn = document.getElementById('join-btn');
        const startGameBtn = document.getElementById('start-game-btn');

        // æ˜¾ç¤ºå…ƒç´ 
        const roomIdDisplay = document.getElementById('room-id-display');
        const lobbyPlayersList = document.getElementById('lobby-players-list');
        const playerCount = document.getElementById('player-count');
        
        // æ¸¸æˆå…ƒç´ 
        const playersListDiv = document.getElementById('players-list');
        const myRoleDisplay = document.getElementById('my-role');
        const teammatesInfo = document.getElementById('teammates-info');
        const missionMarkersDiv = document.getElementById('mission-markers');
        const voteTrackDiv = document.getElementById('vote-track');
        const voteTrackCount = document.getElementById('vote-track-count');
        const gameStatusDiv = document.getElementById('game-status');
        const actionArea = document.getElementById('action-area');
        
        // æ¸¸æˆçŠ¶æ€å˜é‡
        let myPlayerId = '';
        let currentRoomId = '';
        let gameState = null;
        let myRole = '';
        let myAlignment = '';

        // (å·²ä¿®æ­£) è§’è‰²ç¿»è¯‘å¯¹è±¡
        const roleTranslations = {
            'Merlin': 'æ¢…æ—',
            'Percival': 'æ´¾è¥¿ç»´å°”',
            'Loyal_Servant': 'äºšç‘Ÿçš„å¿ è‡£',
            'Morgana': 'è«ç”˜å¨œ',
            'Assassin': 'åˆºå®¢',
            'Mordred': 'è«å¾·é›·å¾·',
            'Minion': 'è«å¾·é›·å¾·çš„çˆªç‰™', 
            'Oberon': 'å¥¥ä¼¯ä¼¦'
        };

        // --- äº‹ä»¶ç›‘å¬ ---
        joinBtn.addEventListener('click', () => {
            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                showNotification('è¯·è¾“å…¥æ˜µç§°');
                return;
            }
            myPlayerId = socket.id;
            const roomId = roomIdInput.value.trim().toUpperCase();
            if (roomId) {
                socket.emit('joinRoom', { roomId, playerName });
            } else {
                socket.emit('createRoom', { playerName });
            }
        });

        startGameBtn.addEventListener('click', () => {
            socket.emit('startGame', currentRoomId);
        });

        // --- Socket.IO ç›‘å¬ ---
        socket.on('connect', () => {
            myPlayerId = socket.id;
        });

        socket.on('roomCreated', (roomId) => {
            currentRoomId = roomId;
            const playerName = playerNameInput.value.trim();
            console.log(`æˆ¿é—´ ${roomId} åˆ›å»ºæˆåŠŸï¼Œç°åœ¨ä½œä¸º ${playerName} åŠ å…¥...`);
            socket.emit('joinRoom', { roomId: currentRoomId, playerName: playerName });
            showLobby();
        });

        socket.on('joinSuccess', (roomId) => {
            console.log(`æˆåŠŸåŠ å…¥æˆ¿é—´ ${roomId}ï¼Œè®¾ç½® currentRoomId`);
            currentRoomId = roomId;
        });

        // (å·²ä¿®æ­£) åªæœ‰ä¸€ä¸ª playerJoined ç›‘å¬å™¨
        socket.on('playerJoined', ({ players }) => {
            showLobby();
            updateLobbyPlayers(players);
        });
        
        socket.on('playerLeft', ({ players }) => {
            if (gameView.classList.contains('hidden')) {
                updateLobbyPlayers(players);
            }
        });

        socket.on('gameStarted', () => {
            loginView.classList.add('hidden');
            lobbyView.classList.add('hidden');
            gameView.classList.remove('hidden');
        });
        
        socket.on('roleAssigned', ({ role, alignment, roleInfo }) => {
            myRole = role;
            myAlignment = alignment;
            
            const roleName = roleTranslations[role] || role;
            const alignmentText = alignment === 'good' ? 'å¥½äºº' : 'åäºº';
            
            myRoleDisplay.textContent = `${roleName} (${alignmentText})`;
            myRoleDisplay.style.color = alignment === 'good' ? 'blue' : 'red';
            
            if (roleInfo && roleInfo.players.length > 0) {
                teammatesInfo.textContent = `${roleInfo.description} ${roleInfo.players.join(', ')}`;
            } else {
                teammatesInfo.textContent = 'ä½ æ²¡æœ‰è·å¾—ä»»ä½•ç‰¹æ®Šæƒ…æŠ¥ã€‚';
            }
        });
        
        socket.on('gameStateUpdate', (newGameState) => {
            console.log("ã€æ”¶åˆ°æ›´æ–°ã€‘æœåŠ¡å™¨å‘æ¥äº†æ–°çš„æ¸¸æˆçŠ¶æ€:", newGameState);
            gameState = newGameState;
            renderGameState();
        });

        socket.on('voteResult', ({ votes, passed }) => {
            let resultText = `æŠ•ç¥¨ç»“æœ: ${passed ? 'é€šè¿‡' : 'å¦å†³'}<br>`;
            for(const playerId in votes) {
                const playerName = gameState.players.find(p => p.id === playerId)?.name;
                resultText += `${playerName}: ${votes[playerId] === 'approve' ? 'åŒæ„' : 'åå¯¹'}<br>`;
            }
            showModal(resultText);
            setTimeout(hideModal, 2500);
        });

        socket.on('missionResult', ({ result, fails }) => {
            showModal(`ä»»åŠ¡${result === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}! å¤±è´¥ç¥¨æ•°: ${fails}`);
            setTimeout(hideModal, 3500);
        });
        
        socket.on('gameOver', ({ winner, reason, roles }) => {
            let roleText = '<h4>æœ€ç»ˆèº«ä»½:</h4>';
            roles.forEach(p => {
                const roleName = roleTranslations[p.role] || p.role;
                const alignment = p.alignment === 'good' ? 'å¥½äºº' : 'åäºº';
                roleText += `<p>${p.name}: ${roleName} (${alignment})</p>`;
            });
            const winnerText = winner ? `${winner === 'good' ? 'å¥½äºº' : 'åäºº'}æ–¹èƒœåˆ©!` : '';
            showModal(`<h2>æ¸¸æˆç»“æŸ</h2><p>${winnerText}</p><p>${reason}</p>${roleText}`);
        });

        socket.on('error', (message) => {
            showNotification(message);
        });

        // --- æ¸²æŸ“å‡½æ•° ---
        function showLobby() {
            loginView.classList.add('hidden');
            lobbyView.classList.remove('hidden');
            roomIdDisplay.textContent = currentRoomId;
        }

        function updateLobbyPlayers(players) {
            lobbyPlayersList.innerHTML = '';
            players.forEach((p, index) => {
                const li = document.createElement('li');
                li.textContent = p.name;
                if (index === 0) li.textContent += " (æˆ¿ä¸»)";
                lobbyPlayersList.appendChild(li);
            });
            playerCount.textContent = `${players.length} äºº`;
            startGameBtn.disabled = players.length < 5 || players.length > 10;
        }

        function renderGameState() {
            if (!gameState) return;

            // æ›´æ–°ç©å®¶åˆ—è¡¨
            playersListDiv.innerHTML = '';
            gameState.players.forEach((player, index) => {
                const playerEl = document.createElement('div');
                playerEl.classList.add('player-item');
                playerEl.dataset.id = player.id;
                playerEl.textContent = player.name;
                if (index === gameState.leaderIndex) {
                    playerEl.classList.add('leader');
                    playerEl.textContent += ' (é¢†è¢–)';
                }
                if(gameState.proposedTeam && gameState.proposedTeam.includes(player.id)) {
                    playerEl.classList.add('on-team');
                }
                playersListDiv.appendChild(playerEl);
            });

            // æ›´æ–°ä»»åŠ¡å’ŒæŠ•ç¥¨è½¨é“
            missionMarkersDiv.innerHTML = '';
            for(let i = 0; i < 5; i++) {
                const marker = document.createElement('div');
                marker.classList.add('mission-marker');
                marker.textContent = gameState.setup.missionTeam[i];
                if(gameState.missionResults[i]) {
                    marker.classList.add(gameState.missionResults[i]);
                }
                missionMarkersDiv.appendChild(marker);
            }
            voteTrackDiv.innerHTML = '';
            voteTrackCount.textContent = gameState.voteTrack;
            for (let i = 0; i < 5; i++) {
                const marker = document.createElement('div');
                marker.classList.add('vote-track-marker');
                if (i < gameState.voteTrack) {
                    marker.classList.add('active');
                }
                voteTrackDiv.appendChild(marker);
            }

            // æ›´æ–°çŠ¶æ€å’Œè¡ŒåŠ¨åŒº
            actionArea.innerHTML = '';
            const isLeader = gameState.players[gameState.leaderIndex].id === myPlayerId;
            const isOnTeam = gameState.proposedTeam && gameState.proposedTeam.includes(myPlayerId);

            switch (gameState.status) {
                case 'proposing':
                    gameStatusDiv.textContent = `ç¬¬ ${gameState.missionRound + 1} è½® - ${gameState.players[gameState.leaderIndex].name} æ­£åœ¨ç»„å»ºé˜Ÿä¼ (éœ€è¦ ${gameState.setup.missionTeam[gameState.missionRound]} äºº)`;
                    if (isLeader) {
                        renderTeamProposal();
                    }
                    break;
                case 'voting':
                    gameStatusDiv.textContent = 'è¯·å¯¹å½“å‰é˜Ÿä¼æŠ•ç¥¨';
                    renderTeamVoteButtons();
                    break;
                case 'mission':
                    gameStatusDiv.textContent = 'è¢«é€‰ä¸­çš„é˜Ÿå‘˜è¯·æ‰§è¡Œä»»åŠ¡';
                    if (isOnTeam) {
                        renderMissionVoteButtons();
                    }
                    break;
                case 'assassination':
                    gameStatusDiv.textContent = 'ä»»åŠ¡3æ¬¡æˆåŠŸï¼è½®åˆ°åˆºå®¢è¡ŒåŠ¨äº†...';
                    if (myRole === 'Assassin') {
                        renderAssassinationChoice();
                    } else {
                        actionArea.innerHTML = '<p>ç­‰å¾…åˆºå®¢é€‰æ‹©åˆºæ€å¯¹è±¡...</p>';
                    }
                    break;
            }
        }

        function renderTeamProposal() {
            actionArea.innerHTML = '<h4>é€‰æ‹©ä½ çš„é˜Ÿå‘˜:</h4>';
            const teamSize = gameState.setup.missionTeam[gameState.missionRound];
            gameState.players.forEach(player => {
                actionArea.innerHTML += `
                    <label>
                        <input type="checkbox" class="team-checkbox" value="${player.id}">
                        ${player.name}
                    </label><br>
                `;
            });
            const proposeBtn = document.createElement('button');
            proposeBtn.textContent = `ç¡®è®¤é€‰æ‹© ${teamSize} äºº`;

            proposeBtn.onclick = () => {
                const selected = Array.from(document.querySelectorAll('.team-checkbox:checked')).map(cb => cb.value);
                if (selected.length !== teamSize) {
                    showNotification(`è¯·æ­£å¥½é€‰æ‹© ${teamSize} äºº`);
                    return;
                }
                socket.emit('proposeTeam', { roomId: currentRoomId, team: selected });
            };
            actionArea.appendChild(proposeBtn);
        }
        
        function renderTeamVoteButtons() {
            actionArea.innerHTML = `
                <button onclick="submitTeamVote('approve')">ğŸ‘ åŒæ„</button>
                <button onclick="submitTeamVote('reject')" style="background-color: #d9534f;">ğŸ‘ åå¯¹</button>
            `;
        }

        function submitTeamVote(vote) {
            socket.emit('voteOnTeam', { roomId: currentRoomId, vote });
            actionArea.innerHTML = '<p>å·²æŠ•ç¥¨ï¼Œç­‰å¾…å…¶ä»–ç©å®¶...</p>';
        }

        // (å·²ä¿®æ­£) æ­£ç¡®çš„æŠ•ç¥¨æŒ‰é’®æ¸²æŸ“å‡½æ•°
        function renderMissionVoteButtons() {
            let buttons = `<button onclick="submitMissionVote('success')" style="background-color: #5cb85c;">âœ… ä»»åŠ¡æˆåŠŸ</button>`;
            if (myAlignment === 'evil') { // ä½¿ç”¨ myAlignment åˆ¤æ–­
                buttons += `<button onclick="submitMissionVote('fail')" style="background-color: #d9534f;">âŒ ä»»åŠ¡å¤±è´¥</button>`;
            }
            actionArea.innerHTML = buttons;
        }

        function submitMissionVote(vote) {
            socket.emit('voteOnMission', { roomId: currentRoomId, vote });
            actionArea.innerHTML = '<p>å·²å‡ºç¥¨ï¼Œç­‰å¾…å…¶ä»–é˜Ÿå‘˜...</p>';
        }

        function renderAssassinationChoice() {
            actionArea.innerHTML = '<h4>é€‰æ‹©ä½ è¦åˆºæ€çš„ç©å®¶:</h4>';
            gameState.players.forEach(player => {
                if (player.id !== myPlayerId) {
                    const btn = document.createElement('button');
                    btn.style.margin = '5px';
                    btn.textContent = `åˆºæ€ ${player.name}`;
                    btn.onclick = () => submitAssassination(player.id);
                    actionArea.appendChild(btn);
                }
            });
        }

        function submitAssassination(targetId) {
            socket.emit('assassinate', { roomId: currentRoomId, targetId });
            actionArea.innerHTML = '<p>å·²é€‰æ‹©ç›®æ ‡ï¼Œç­‰å¾…æœ€ç»ˆç»“æœ...</p>';
        }

        // --- å·¥å…·å‡½æ•° ---
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.remove('hidden');
            setTimeout(() => notification.classList.add('hidden'), 3000);
        }

        function showModal(content) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = content;
            modal.classList.remove('hidden');
        }
        
        function hideModal() {
            document.getElementById('modal').classList.add('hidden');
        }
    </script>
</body>
</html>