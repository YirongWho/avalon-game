<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿ç“¦éš†åœ¨çº¿</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background-color: #f0f2f5; }
        .container { width: 90%; max-width: 800px; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        h1, h2 { text-align: center; color: #333; }
        .input-group { margin-bottom: 15px; }
        input[type="text"], button { width: 100%; padding: 12px; font-size: 16px; border-radius: 4px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button.danger-btn { background-color: #dc3545; } /* âœ¨ MODIFICATION: å±é™©æ“ä½œæŒ‰é’®æ ·å¼ */
        button.danger-btn:hover { background-color: #c82333; } /* âœ¨ MODIFICATION: å±é™©æ“ä½œæŒ‰é’®æ ·å¼ */
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #game-board { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        #players-info, #game-info { padding: 15px; border: 1px solid #eee; border-radius: 5px; }
        #game-info { display: flex; flex-direction: column; }
        #game-status { margin-top: 5px; margin-bottom: 15px; text-align: center; font-weight: bold; color: #495057; }
        .info-block { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 12px; margin-bottom: 15px; }
        .info-block p { margin: 8px 0; }
        #game-info h4 { margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        #players-list label { display: block; padding: 5px; }
        .player-item { padding: 4px; border-radius: 3px; } /* âœ¨ MODIFICATION: åŸºç¡€æ ·å¼ */
        .player-item.leader { font-weight: bold; color: orange; }
        .player-item.lady { font-weight: bold; color: #17a2b8; }
        .player-item.on-team { background-color: #dff0d8; }
        /* âœ¨ MODIFICATION START: æ‰çº¿ç©å®¶çš„æ ·å¼ */
        .player-item.disconnected {
            color: #999;
            font-style: italic;
            text-decoration: line-through;
        }
        /* âœ¨ MODIFICATION END */
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.7); color: white; padding: 15px 25px; border-radius: 5px; z-index: 1000; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; text-align: center; max-height: 80vh; overflow-y: auto;}
        #mission-markers { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .mission-marker { position: relative; width: 40px; height: 40px; border: 2px solid #ccc; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        .mission-marker.success { background-color: #5cb85c; color: white; border-color: #4cae4c; }
        .mission-marker.fail { background-color: #d9534f; color: white; border-color: #d43f3a; }
        .vote-track-marker { width: 20px; height: 20px; border: 1px solid #333; border-radius: 50%; }
        .vote-track-marker.active { background-color: #d9534f; }
        #log-button { background-color: #6c757d; margin-top: 10px; }
        #log-button:hover { background-color: #5a6268; }
        #log-modal-content { text-align: left; max-width: 500px; width: 90%;}
        .log-entry { border-bottom: 1px solid #eee; padding: 10px 0; }
        .log-entry:last-child { border-bottom: none; }
        .log-entry h5 { margin: 0 0 5px 0; }
        .log-votes { font-size: 0.9em; }
        .two-fails-indicator { position: absolute; top: 2px; right: 4px; font-size: 12px; font-weight: bold; line-height: 1; text-shadow: 0 0 3px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <div class="container">
        <div id="login-view">
            <h1>é˜¿ç“¦éš†</h1>
            <div class="input-group">
                <input type="text" id="player-name" placeholder="è¾“å…¥ä½ çš„æ˜µç§°">
            </div>
            <div class="input-group">
                <input type="text" id="room-id-input" placeholder="è¾“å…¥æˆ¿é—´å· (ç•™ç©ºåˆ™åˆ›å»º)">
            </div>
            <button id="join-btn">åŠ å…¥/åˆ›å»ºæˆ¿é—´</button>
        </div>

        <div id="lobby-view" class="hidden">
            <h2>æˆ¿é—´å·: <span id="room-id-display"></span></h2>
            <h3>ç©å®¶åˆ—è¡¨ (<span id="player-count"></span>):</h3>
            <ul id="lobby-players-list"></ul>
            <button id="start-game-btn">å¼€å§‹æ¸¸æˆ (5-10äºº)</button>
            <button id="close-room-btn" class="danger-btn hidden" style="margin-top: 10px;">å…³é—­æˆ¿é—´</button>
            </div>

        <div id="game-view" class="hidden">
            <div id="game-board">
                <div id="players-info">
                    <h3>ç©å®¶åˆ—è¡¨</h3>
                    <div id="players-list"></div>
                    <button id="log-button">æŸ¥çœ‹æ¸¸æˆæ—¥å¿—</button>
                    <button id="force-end-game-btn" class="danger-btn hidden" style="margin-top: 10px;">å¼ºåˆ¶ç»“æŸæ¸¸æˆ</button>
                    </div>
                <div id="game-info">
                    <div class="info-block">
                        <h4>æˆ‘çš„æƒ…æŠ¥</h4>
                        <p><strong>èº«ä»½:</strong> <span id="my-role"></span></p>
                        <div id="role-info-panel">
                            <p id="teammates-info" style="min-height: 1.5em;"></p>
                            <div id="lady-info"></div>
                        </div>
                    </div>
                    <div class="info-block">
                        <h4>æ¸¸æˆé¢æ¿</h4>
                        <strong>ä»»åŠ¡è¿›åº¦:</strong>
                        <div id="mission-markers"></div>
                        <strong>æŠ•ç¥¨è½¨é“ (<span id="vote-track-count">0</span>/5):</strong>
                        <div id="vote-track" style="display: flex; gap: 5px; margin-top: 5px;"></div>
                    </div>
                    <div id="game-status"></div>
                    <div id="action-area"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification" class="hidden notification"></div>
    <div id="modal" class="hidden modal-overlay">
        <div class="modal-content" id="modal-content"></div>
    </div>
    
    <div id="log-modal" class="hidden modal-overlay">
        <div class="modal-content" id="log-modal-content">
            <h2 style="margin-top:0;">æ¸¸æˆæ—¥å¿—</h2>
            <div id="log-entries"></div>
            <button id="close-log-btn" style="margin-top: 20px;">å…³é—­</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // âœ¨ MODIFICATION START: socketè¿æ¥é€‰é¡¹ï¼Œå¼€å¯é‡è¿
        const socket = io({
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
        });
        // âœ¨ MODIFICATION END

        // Views and Inputs
        const loginView = document.getElementById('login-view');
        const lobbyView = document.getElementById('lobby-view');
        const gameView = document.getElementById('game-view');
        const playerNameInput = document.getElementById('player-name');
        const roomIdInput = document.getElementById('room-id-input');
        
        // Buttons
        const joinBtn = document.getElementById('join-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const logButton = document.getElementById('log-button');
        const closeLogBtn = document.getElementById('close-log-btn');
        const closeRoomBtn = document.getElementById('close-room-btn'); // âœ¨ MODIFICATION: æ–°å¢æŒ‰é’®
        const forceEndGameBtn = document.getElementById('force-end-game-btn'); // âœ¨ MODIFICATION: æ–°å¢æŒ‰é’®
        // Buttons
        const leaveRoomBtn = document.createElement('button'); // åŠ¨æ€åˆ›å»ºé€€å‡ºæˆ¿é—´æŒ‰é’®
        leaveRoomBtn.textContent = 'é€€å‡ºæˆ¿é—´';
        leaveRoomBtn.classList.add('danger-btn', 'hidden'); // é»˜è®¤éšè—
        leaveRoomBtn.style.marginTop = '10px';
        lobbyView.appendChild(leaveRoomBtn); //
        // Displays
        const roomIdDisplay = document.getElementById('room-id-display');
        const lobbyPlayersList = document.getElementById('lobby-players-list');
        const playerCount = document.getElementById('player-count');
        const playersListDiv = document.getElementById('players-list');
        const myRoleDisplay = document.getElementById('my-role');
        const teammatesInfo = document.getElementById('teammates-info');
        const ladyInfoDiv = document.getElementById('lady-info');
        const missionMarkersDiv = document.getElementById('mission-markers');
        const voteTrackDiv = document.getElementById('vote-track');
        const voteTrackCount = document.getElementById('vote-track-count');
        const gameStatusDiv = document.getElementById('game-status');
        const actionArea = document.getElementById('action-area');
        const logModal = document.getElementById('log-modal');
        const logEntriesDiv = document.getElementById('log-entries');

        // âœ¨ MODIFICATION START: é‡æ„çŠ¶æ€å˜é‡
        let myPersistentPlayerId = null; // æ°¸ä¹…IDï¼Œç”¨äºé‡è¿
        let currentRoomId = '';
        let gameState = null;
        let myRole = '';
        let myAlignment = '';
        let amIHost = false; // æ˜¯å¦æ˜¯æˆ¿ä¸»
        // âœ¨ MODIFICATION END

        const roleTranslations = { 'Merlin': 'æ¢…æ—', 'Percival': 'æ´¾è¥¿ç»´å°”', 'Loyal_Servant': 'äºšç‘Ÿçš„å¿ è‡£', 'Morgana': 'è«ç”˜å¨œ', 'Assassin': 'åˆºå®¢', 'Mordred': 'è«å¾·é›·å¾·', 'Minion': 'è«å¾·é›·å¾·çš„çˆªç‰™', 'Oberon': 'å¥¥ä¼¯ä¼¦' };

        // --- Event Listeners ---
        joinBtn.addEventListener('click', () => {
            const playerName = playerNameInput.value.trim();
            if (!playerName) { showNotification('è¯·è¾“å…¥æ˜µç§°'); return; }
            const roomId = roomIdInput.value.trim().toUpperCase();
            if (roomId) { socket.emit('joinRoom', { roomId, playerName }); } 
            else { socket.emit('createRoom', { playerName }); }
        });
        // âœ¨ æ–°å¢é€€å‡ºæˆ¿é—´æŒ‰é’®çš„äº‹ä»¶ç›‘å¬
        leaveRoomBtn.addEventListener('click', () => {
            if (confirm('ä½ ç¡®å®šè¦é€€å‡ºæˆ¿é—´å—ï¼Ÿ')) {
                socket.emit('leaveRoom', currentRoomId);
                resetToLogin(); // é‡ç½®åˆ°ç™»å½•é¡µé¢
            }
        });
        
        startGameBtn.addEventListener('click', () => socket.emit('startGame', currentRoomId));
        logButton.addEventListener('click', () => logModal.classList.remove('hidden'));
        closeLogBtn.addEventListener('click', () => logModal.classList.add('hidden'));
        logModal.addEventListener('click', (e) => { if (e.target === logModal) logModal.classList.add('hidden'); });

        // âœ¨ MODIFICATION START: æˆ¿ä¸»æŒ‰é’®çš„äº‹ä»¶ç›‘å¬
        closeRoomBtn.addEventListener('click', () => {
            socket.emit('closeRoom', currentRoomId);
        });

        forceEndGameBtn.addEventListener('click', () => {
            if (confirm('ä½ ç¡®å®šè¦å¼ºåˆ¶ç»“æŸæ¸¸æˆå—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼')) {
                socket.emit('forceEndGameByHost', currentRoomId);
            }
        });
        // âœ¨ MODIFICATION END

        // --- Socket.IO Listeners ---

        // âœ¨ MODIFICATION START: é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦é‡è¿
        window.addEventListener('load', () => {
            const storedRoomId = localStorage.getItem('avalonRoomId');
            const storedPlayerId = localStorage.getItem('avalonPlayerId');
            if (storedRoomId && storedPlayerId) {
                console.log(`Found session data, attempting to reconnect to room ${storedRoomId} as player ${storedPlayerId}`);
                currentRoomId = storedRoomId;
                myPersistentPlayerId = storedPlayerId;
                socket.emit('attemptReconnect', { roomId: storedRoomId, playerId: storedPlayerId });
                showNotification('æ­£åœ¨å°è¯•é‡æ–°è¿æ¥...');
            }
        });
        // âœ¨ MODIFICATION END
        
        socket.on('roomCreated', (roomId) => {
            const playerName = playerNameInput.value.trim();
            socket.emit('joinRoom', { roomId: roomId, playerName: playerName });
        });
        
        // âœ¨ MODIFICATION: joinSuccessç°åœ¨æ˜¯åŠ å…¥æˆ¿é—´çš„å”¯ä¸€å‡­è¯ï¼Œä¼šè¿”å›æ°¸ä¹…ID
        socket.on('joinSuccess', ({ roomId, playerId, isHost }) => {
            console.log(`Successfully joined room ${roomId} with persistent ID ${playerId}`);
            currentRoomId = roomId;
            myPersistentPlayerId = playerId;
            localStorage.setItem('avalonRoomId', roomId);
            localStorage.setItem('avalonPlayerId', playerId);
            showLobby();

            amIHost = isHost;
            if (amIHost) {
                closeRoomBtn.classList.remove('hidden');
                leaveRoomBtn.classList.add('hidden');
            } else {
                closeRoomBtn.classList.add('hidden');
                leaveRoomBtn.classList.remove('hidden');
    }
        });

        // ä¿®æ”¹ playerJoined äº‹ä»¶ï¼ŒåŠ¨æ€æ˜¾ç¤ºé€€å‡ºæŒ‰é’®
        socket.on('playerJoined', ({ players }) => {
            updateLobbyPlayers(players);
            const me = players.find(p => p.playerId === myPersistentPlayerId);
            console.log('Current player info:', me);
            if (me) {
                amIHost = me.isHost;
                console.log(`Player joined. Am I host? ${amIHost}`);
                if (amIHost) {
                    closeRoomBtn.classList.remove('hidden'); // æˆ¿ä¸»æ˜¾ç¤ºå…³é—­æˆ¿é—´æŒ‰é’®
                    leaveRoomBtn.classList.add('hidden'); // æˆ¿ä¸»ä¸æ˜¾ç¤ºé€€å‡ºæŒ‰é’®
                } else {
                    closeRoomBtn.classList.add('hidden'); // éæˆ¿ä¸»éšè—å…³é—­æˆ¿é—´æŒ‰é’®
                    leaveRoomBtn.classList.remove('hidden'); // éæˆ¿ä¸»æ˜¾ç¤ºé€€å‡ºæŒ‰é’®
                }
            }
        });
        // âœ¨ æ–°å¢ leaveRoom äº‹ä»¶ç›‘å¬
        socket.on('roomLeft', () => {
            showNotification('ä½ å·²é€€å‡ºæˆ¿é—´');
            resetToLogin(); // é‡ç½®åˆ°ç™»å½•é¡µé¢
        });
        
        // âœ¨ MODIFICATION START: å…¨æ–°çš„é‡è¿ç›¸å…³äº‹ä»¶
        socket.on('reconnectSuccess', ({ room, gameState: newGameState, playerInfo }) => {
            showNotification('é‡è¿æˆåŠŸï¼');
            console.log('Reconnect successful. Restoring state:', { room, newGameState, playerInfo });

            // æ¢å¤ä¸ªäººä¿¡æ¯
            const me = room.players.find(p => p.playerId === myPersistentPlayerId);
            if (me) amIHost = me.isHost;
            
            gameState = newGameState;

            // âœ¨ FIX START: æ ¹æ®æ¸¸æˆçŠ¶æ€å†³å®šæ˜¾ç¤ºå“ªä¸ªç•Œé¢
            if (gameState.status === 'lobby') {
                // æ¸¸æˆæœªå¼€å§‹ï¼Œæ˜¾ç¤ºå¤§å…ç•Œé¢
                showLobby();
                updateLobbyPlayers(room.players);
                // æ ¹æ®æ˜¯å¦æˆ¿ä¸»æ˜¾ç¤ºå¯¹åº”æŒ‰é’®
                if (amIHost) {
                    closeRoomBtn.classList.remove('hidden');
                    leaveRoomBtn.classList.add('hidden');
                } else {
                    closeRoomBtn.classList.add('hidden');
                    leaveRoomBtn.classList.remove('hidden');
                }
                showNotification('é‡è¿æˆåŠŸï¼Œè¿”å›æ¸¸æˆå¤§å…');
            } else {
                // æ¸¸æˆå·²å¼€å§‹ï¼Œæ˜¾ç¤ºæ¸¸æˆç•Œé¢å¹¶æ¢å¤è§’è‰²ä¿¡æ¯
                loginView.classList.add('hidden');
                lobbyView.classList.add('hidden');
                gameView.classList.remove('hidden');

                // æ¢å¤è§’è‰²ä¿¡æ¯
                if (playerInfo) {
                    myRole = playerInfo.role;
                    myAlignment = playerInfo.alignment;
                    const roleName = roleTranslations[myRole] || myRole;
                    const alignmentText = myAlignment === 'good' ? 'å¥½äºº' : 'åäºº';
                    myRoleDisplay.textContent = `${roleName} (${alignmentText})`;
                    myRoleDisplay.style.color = myAlignment === 'good' ? 'blue' : 'red';
                    if (playerInfo.roleInfo && playerInfo.roleInfo.players.length > 0) {
                        teammatesInfo.textContent = `${playerInfo.roleInfo.description} ${playerInfo.roleInfo.players.join(', ')}`;
                    } else { 
                        teammatesInfo.textContent = 'ä½ æ²¡æœ‰è·å¾—ä»»ä½•ç‰¹æ®Šæƒ…æŠ¥ã€‚'; 
                    }
                }

                // æ¸²æŸ“æ•´ä¸ªæ¸¸æˆç•Œé¢
                renderGameState();
                updateGameLog(gameState.gameLog);
            }
            // âœ¨ FIX END
        });

        socket.on('reconnectFailed', () => {
            showNotification('é‡è¿å¤±è´¥ï¼Œæ¸¸æˆå¯èƒ½å·²ç»“æŸã€‚');
            resetToLogin();
        });

        // ç›‘å¬ç©å®¶è¿æ¥çŠ¶æ€å˜åŒ–
        socket.on('playerConnectionUpdate', ({ playerId, connected }) => {
            if (gameState && gameState.players) {
                const player = gameState.players.find(p => p.playerId === playerId);
                if (player) {
                    player.connected = connected;
                    renderGameState(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°UI
                }
            }
            if (!gameView.classList.contains('hidden')) { // å¦‚æœåœ¨æ¸¸æˆå†…
                const playerInLobby = lobbyPlayersList.querySelector(`[data-player-id="${playerId}"]`);
                if(playerInLobby) {
                    playerInLobby.style.textDecoration = connected ? 'none' : 'line-through';
                    playerInLobby.style.color = connected ? 'inherit' : '#999';
                }
            }
        });
        // âœ¨ MODIFICATION END

        socket.on('gameStarted', () => {
            loginView.classList.add('hidden');
            lobbyView.classList.add('hidden');
            gameView.classList.remove('hidden');
        });

        // âœ¨ MODIFICATION START: ç›‘å¬æˆ¿é—´å…³é—­å’Œæ¸¸æˆå¼ºåˆ¶ç»“æŸäº‹ä»¶
        socket.on('roomClosed', (reason) => {
            showNotification(reason);
            resetToLogin();
        });

        socket.on('gameForciblyEnded', (reason) => {
            showModal(`<h2>æ¸¸æˆè¢«æ„å¤–ä¸­æ­¢</h2><p>${reason}</p>`);
            setTimeout(() => {
                hideModal();
                resetToLogin();
            }, 4000);
        });
        // âœ¨ MODIFICATION END
        
        socket.on('roleAssigned', ({ role, alignment, roleInfo }) => {
            myRole = role;
            myAlignment = alignment;
            const roleName = roleTranslations[role] || role;
            const alignmentText = alignment === 'good' ? 'å¥½äºº' : 'åäºº';
            myRoleDisplay.textContent = `${roleName} (${alignmentText})`;
            myRoleDisplay.style.color = alignment === 'good' ? 'blue' : 'red';
            if (roleInfo && roleInfo.players.length > 0) {
                teammatesInfo.textContent = `${roleInfo.description} ${roleInfo.players.join(', ')}`;
            } else { teammatesInfo.textContent = 'ä½ æ²¡æœ‰è·å¾—ä»»ä½•ç‰¹æ®Šæƒ…æŠ¥ã€‚'; }
        });

        socket.on('gameStateUpdate', (newGameState) => {
            console.log("ã€æ”¶åˆ°æ›´æ–°ã€‘æœåŠ¡å™¨å‘æ¥äº†æ–°çš„æ¸¸æˆçŠ¶æ€:", newGameState);
            gameState = newGameState;
            renderGameState();
            updateGameLog(gameState.gameLog);
        });

        socket.on('voteResult', ({ votes, passed }) => {
            let resultText = `æŠ•ç¥¨ç»“æœ: ${passed ? 'é€šè¿‡' : 'å¦å†³'}<br>`;
            // âœ¨ MODIFICATION: ä½¿ç”¨playerIdæŸ¥æ‰¾ç©å®¶åå­—
            for(const playerId in votes) {
                const playerName = gameState.players.find(p => p.playerId === playerId)?.name;
                resultText += `${playerName}: ${votes[playerId] === 'approve' ? 'åŒæ„' : 'åå¯¹'}<br>`;
            }
            showModal(resultText);
            setTimeout(hideModal, 2500);
        });

        socket.on('missionResult', ({ result, fails }) => {
            showModal(`ä»»åŠ¡${result === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}! å¤±è´¥ç¥¨æ•°: ${fails}`);
            setTimeout(hideModal, 3500);
        });

        socket.on('ladyOfTheLakeResult', ({ targetName, alignment }) => {
            const resultHtml = `<p>ğŸ§œâ€â™€ï¸ æ¹–ä¸­å¥³ç¥: ä½ çœ‹åˆ° <strong>${targetName}</strong> æ˜¯ <span style="font-weight:bold; color:${alignment === 'good' ? 'blue' : 'red'};">${alignment === 'good' ? 'å¥½äºº' : 'åäºº'}</span> é˜µè¥çš„ã€‚</p>`;
            ladyInfoDiv.innerHTML += resultHtml;
            showNotification(`ä½ æŸ¥éªŒäº† ${targetName} çš„èº«ä»½ã€‚`);
        });

        socket.on('gameOver', ({ winner, reason, roles }) => {
            let roleText = '<h4>æœ€ç»ˆèº«ä»½:</h4>';
            roles.forEach(p => {
                const roleName = roleTranslations[p.role] || p.role;
                const alignment = p.alignment === 'good' ? 'å¥½äºº' : 'åäºº';
                roleText += `<p>${p.name}: ${roleName} (${alignment})</p>`;
            });
            const winnerText = winner ? `${winner === 'good' ? 'å¥½äºº' : 'åäºº'}æ–¹èƒœåˆ©!` : '';
            showModal(`<h2>æ¸¸æˆç»“æŸ</h2><p>${winnerText}</p><p>${reason}</p>${roleText}`);
            // âœ¨ MODIFICATION: æ¸¸æˆç»“æŸåæ¸…é™¤æœ¬åœ°å­˜å‚¨
            setTimeout(resetToLogin, 10000);
        });

        socket.on('error', (message) => showNotification(message));

        // --- Render and Utility Functions ---
        function showLobby() {
            loginView.classList.add('hidden');
            lobbyView.classList.remove('hidden');
            roomIdDisplay.textContent = currentRoomId;
        }

        // âœ¨ MODIFICATION: æ›´æ–°å¤§å…ç©å®¶åˆ—è¡¨ï¼Œæ˜¾ç¤ºæˆ¿ä¸»å’Œè¿æ¥çŠ¶æ€
        function updateLobbyPlayers(players) {
            lobbyPlayersList.innerHTML = '';
            players.forEach(p => {
                const li = document.createElement('li');
                li.dataset.playerId = p.playerId; // æ·»åŠ IDæ–¹ä¾¿æŸ¥æ‰¾
                let text = p.name;
                if (p.isHost) text += " (æˆ¿ä¸»)";
                li.textContent = text;
                if (!p.connected) {
                    li.style.textDecoration = 'line-through';
                    li.style.color = '#999';
                }
                lobbyPlayersList.appendChild(li);
            });
            playerCount.textContent = `${players.length} äºº`;
            startGameBtn.disabled = players.length < 5 || players.length > 10;
        }

        // âœ¨ MODIFICATION: æ ¸å¿ƒæ¸²æŸ“å‡½æ•°ï¼Œå¢åŠ æˆ¿ä¸»æŒ‰é’®æ˜¾ç¤ºå’Œæ‰çº¿çŠ¶æ€æ˜¾ç¤º
        function renderGameState() {
            if (!gameState) return;
            
            // æ›´æ–°æˆ¿ä¸»æŒ‰é’®å¯è§æ€§
            if (amIHost) {
                forceEndGameBtn.classList.remove('hidden');
            }

            playersListDiv.innerHTML = '';
            gameState.players.forEach((player, index) => {
                const playerEl = document.createElement('div');
                playerEl.classList.add('player-item');
                let text = player.name;
                if (index === gameState.leaderIndex) {
                    playerEl.classList.add('leader');
                    text += ' (é¢†è¢–)';
                }
                if (gameState.ladyOfTheLake && player.playerId === gameState.ladyOfTheLake.holderId) {
                    playerEl.classList.add('lady');
                    text += ' ğŸ§œâ€â™€ï¸';
                }
                if (!player.connected) {
                    playerEl.classList.add('disconnected');
                    text += ' (æ‰çº¿)';
                }
                playerEl.textContent = text;
                if(gameState.proposedTeam && gameState.proposedTeam.includes(player.playerId)) {
                    playerEl.classList.add('on-team');
                }
                playersListDiv.appendChild(playerEl);
            });

            missionMarkersDiv.innerHTML = '';
            for(let i = 0; i < 5; i++) {
                const marker = document.createElement('div');
                marker.classList.add('mission-marker');
                const content = gameState.setup.missionTeam[i];
                if (i === 3 && gameState.setup.twoFailsRequired) {
                    marker.innerHTML = `${content}<sup class="two-fails-indicator">+1</sup>`;
                } else {
                    marker.textContent = content;
                }
                if(gameState.missionResults[i]) {
                    marker.classList.add(gameState.missionResults[i]);
                }
                missionMarkersDiv.appendChild(marker);
            }

            voteTrackDiv.innerHTML = '';
            voteTrackCount.textContent = gameState.voteTrack;
            for (let i = 0; i < 5; i++) {
                const marker = document.createElement('div');
                marker.classList.add('vote-track-marker');
                if (i < gameState.voteTrack) marker.classList.add('active');
                voteTrackDiv.appendChild(marker);
            }
            
            actionArea.innerHTML = '';
            const me = gameState.players.find(p => p.playerId === myPersistentPlayerId);
            if (!me) return;

            const isLeader = gameState.players[gameState.leaderIndex].playerId === myPersistentPlayerId;
            const isOnTeam = gameState.proposedTeam && gameState.proposedTeam.includes(myPersistentPlayerId);
            const isLady = gameState.ladyOfTheLake && gameState.ladyOfTheLake.holderId === myPersistentPlayerId;

            switch (gameState.status) {
                case 'proposing':
                    gameStatusDiv.textContent = `ç¬¬ ${gameState.missionRound + 1} è½® - ${gameState.players[gameState.leaderIndex].name} æ­£åœ¨ç»„å»ºé˜Ÿä¼ (éœ€è¦ ${gameState.setup.missionTeam[gameState.missionRound]} äºº)`;
                    if (isLeader) { renderTeamProposal(); }
                    break;
                case 'voting':
                    gameStatusDiv.textContent = 'è¯·å¯¹å½“å‰é˜Ÿä¼æŠ•ç¥¨';
                    renderTeamVoteButtons();
                    break;
                case 'mission':
                    gameStatusDiv.textContent = 'è¢«é€‰ä¸­çš„é˜Ÿå‘˜è¯·æ‰§è¡Œä»»åŠ¡';
                    if (isOnTeam) { renderMissionVoteButtons(); }
                    break;
                case 'assassination':
                    gameStatusDiv.textContent = 'ä»»åŠ¡3æ¬¡æˆåŠŸï¼è½®åˆ°åˆºå®¢è¡ŒåŠ¨äº†...';
                    if (myRole === 'Assassin') { renderAssassinationChoice(); } 
                    else { actionArea.innerHTML = '<p>ç­‰å¾…åˆºå®¢é€‰æ‹©åˆºæ€å¯¹è±¡...</p>'; }
                    break;
                case 'ladyOfTheLake':
                    const ladyHolderName = gameState.players.find(p => p.playerId === gameState.ladyOfTheLake.holderId)?.name;
                    gameStatusDiv.textContent = `æ¹–ä¸­å¥³ç¥é˜¶æ®µ - ç­‰å¾… ${ladyHolderName} æŸ¥éªŒç©å®¶èº«ä»½...`;
                    if(isLady) { renderLadyOfTheLakeChoice(); }
                    break;
            }
        }
        
        function updateGameLog(gameLog) {
            if (!gameLog) { logEntriesDiv.innerHTML = '<p>æš‚æ— è®°å½•ã€‚</p>'; return; }
            logEntriesDiv.innerHTML = gameLog.slice().reverse().map(entry => {
                switch(entry.type) {
                    case 'proposal':
                        const approves = [];
                        const rejects = [];
                        // âœ¨ MODIFICATION: ä½¿ç”¨playerIdæŸ¥æ‰¾ç©å®¶åå­—
                        for (const playerId in entry.votes) {
                            const playerName = gameState.players.find(p => p.playerId === playerId)?.name || 'æœªçŸ¥ç©å®¶';
                            if (entry.votes[playerId] === 'approve') approves.push(playerName);
                            else rejects.push(playerName);
                        }
                        return `<div class="log-entry"><h5>ç¬¬${entry.quest}è½® / ç¬¬${entry.proposal}æ¬¡æè®® (${entry.result === 'passed' ? 'é€šè¿‡' : 'å¦å†³'})</h5><p><strong>é˜Ÿé•¿:</strong> ${entry.leader}</p><p><strong>é˜Ÿä¼:</strong> ${entry.team.join(', ')}</p><div class="log-votes"><p style="color:green; margin:2px 0;"><strong>åŒæ„ (${approves.length}):</strong> ${approves.join(', ') || 'æ— '}</p><p style="color:red; margin:2px 0;"><strong>åå¯¹ (${rejects.length}):</strong> ${rejects.join(', ') || 'æ— '}</p></div></div>`;
                    case 'ladyOfTheLake':
                        return `<div class="log-entry"><h5>ç¬¬${entry.quest}è½® - æ¹–ä¸­å¥³ç¥äº‹ä»¶</h5><p>ğŸ§œâ€â™€ï¸ <strong>${entry.oldHolder}</strong> (æ¹–ä¸­å¥³ç¥) æŸ¥éªŒäº† <strong>${entry.checkedPlayer}</strong>ã€‚</p><p>æ–°çš„æ¹–ä¸­å¥³ç¥ç°åœ¨æ˜¯ <strong>${entry.checkedPlayer}</strong>ã€‚</p></div>`;
                    default: return '';
                }
            }).join('');
        }
        
        // âœ¨ MODIFICATION: æ‰€æœ‰æäº¤IDçš„å‡½æ•°ç°åœ¨éƒ½ä½¿ç”¨playerId
        function renderTeamProposal() {
            actionArea.innerHTML = '<h4>é€‰æ‹©ä½ çš„é˜Ÿå‘˜:</h4>';
            const teamSize = gameState.setup.missionTeam[gameState.missionRound];
            gameState.players.forEach(player => {
                actionArea.innerHTML += `<label><input type="checkbox" class="team-checkbox" value="${player.playerId}"> ${player.name}</label><br>`;
            });
            const proposeBtn = document.createElement('button');
            proposeBtn.textContent = `ç¡®è®¤é€‰æ‹© ${teamSize} äºº`;
            proposeBtn.onclick = () => {
                const selected = Array.from(document.querySelectorAll('.team-checkbox:checked')).map(cb => cb.value);
                if (selected.length !== teamSize) {
                    showNotification(`è¯·æ­£å¥½é€‰æ‹© ${teamSize} äºº`);
                    return;
                }
                socket.emit('proposeTeam', { roomId: currentRoomId, team: selected });
            };
            actionArea.appendChild(proposeBtn);
        }

        function renderTeamVoteButtons() { actionArea.innerHTML = `<button onclick="submitTeamVote('approve')">ğŸ‘ åŒæ„</button><button onclick="submitTeamVote('reject')" style="background-color: #d9534f;">ğŸ‘ åå¯¹</button>`; }
        function submitTeamVote(vote) { socket.emit('voteOnTeam', { roomId: currentRoomId, vote }); actionArea.innerHTML = '<p>å·²æŠ•ç¥¨ï¼Œç­‰å¾…å…¶ä»–ç©å®¶...</p>'; }
        function renderMissionVoteButtons() { let buttons = `<button onclick="submitMissionVote('success')" style="background-color: #5cb85c;">âœ… ä»»åŠ¡æˆåŠŸ</button>`; if (myAlignment === 'evil') { buttons += `<button onclick="submitMissionVote('fail')" style="background-color: #d9534f;">âŒ ä»»åŠ¡å¤±è´¥</button>`; } actionArea.innerHTML = buttons; }
        function submitMissionVote(vote) { socket.emit('voteOnMission', { roomId: currentRoomId, vote }); actionArea.innerHTML = '<p>å·²å‡ºç¥¨ï¼Œç­‰å¾…å…¶ä»–é˜Ÿå‘˜...</p>'; }
        
        function renderAssassinationChoice() {
            actionArea.innerHTML = '<h4>é€‰æ‹©ä½ è¦åˆºæ€çš„å¥½äººé˜µè¥ç©å®¶:</h4>';
            if (!gameState.assassinationTargets) { actionArea.innerHTML = '<p>æ­£åœ¨è·å–ç›®æ ‡åˆ—è¡¨...</p>'; return; }
            gameState.assassinationTargets.forEach(player => {
                const btn = document.createElement('button');
                btn.style.margin = '5px';
                btn.textContent = `åˆºæ€ ${player.name}`;
                btn.onclick = () => submitAssassination(player.playerId);
                actionArea.appendChild(btn);
            });
        }
        function submitAssassination(targetId) { socket.emit('assassinate', { roomId: currentRoomId, targetId }); actionArea.innerHTML = '<p>å·²é€‰æ‹©ç›®æ ‡ï¼Œç­‰å¾…æœ€ç»ˆç»“æœ...</p>'; }
        
        function renderLadyOfTheLakeChoice() {
            actionArea.innerHTML = '<h4>ğŸ§œâ€â™€ï¸ æ¹–ä¸­å¥³ç¥: é€‰æ‹©ä¸€ä½ç©å®¶æŸ¥éªŒèº«ä»½</h4>';
            const previousHolders = gameState.ladyOfTheLake.previousHolders;
            gameState.players.forEach(player => {
                if (player.playerId !== myPersistentPlayerId && !previousHolders.includes(player.playerId)) {
                    const btn = document.createElement('button');
                    btn.style.margin = '5px';
                    btn.textContent = `æŸ¥éªŒ ${player.name}`;
                    btn.onclick = () => submitLadyChoice(player.playerId);
                    actionArea.appendChild(btn);
                }
            });
        }
        function submitLadyChoice(targetId) { socket.emit('useLadyOfTheLake', { roomId: currentRoomId, targetId }); actionArea.innerHTML = '<p>å·²é€‰æ‹©ï¼Œç­‰å¾…ç»“æœ...</p>'; }
        
        // âœ¨ MODIFICATION START: æ–°å¢ä¸€ä¸ªé‡ç½®åˆ°ç™»å½•é¡µé¢çš„å‡½æ•°
        function resetToLogin() {
            localStorage.removeItem('avalonRoomId');
            localStorage.removeItem('avalonPlayerId');
            
            myPersistentPlayerId = null;
            currentRoomId = '';
            gameState = null;
            myRole = '';
            myAlignment = '';
            amIHost = false;

            loginView.classList.remove('hidden');
            lobbyView.classList.add('hidden');
            gameView.classList.add('hidden');
            
            // æ¸…ç†UI
            ladyInfoDiv.innerHTML = '';
            playerNameInput.value = '';
            roomIdInput.value = '';
        }
        // âœ¨ MODIFICATION END

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.remove('hidden');
            setTimeout(() => notification.classList.add('hidden'), 3000);
        }
        function showModal(content) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = content;
            modal.classList.remove('hidden');
        }
        function hideModal() { document.getElementById('modal').classList.add('hidden'); }
    </script>
</body>
</html>